<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>La Esquina | Gastrobar</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=DM+Sans:opsz,wght@9..40,400;500;700&display=swap" rel="stylesheet">
    
    <!-- Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

    <style>
        body { 
            font-family: 'DM Sans', sans-serif; 
            background-color: #faf9f6; /* Stone 50 */
            color: #1c1917; /* Stone 900 */
            -webkit-tap-highlight-color: transparent;
        }
        .font-brand { font-family: 'Caveat', cursive; }
        
        /* Hide Scrollbar */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Chips */
        .chip {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .chip-active {
            background-color: #1c1917; /* Stone 900 */
            color: #fafaf9;
            border-color: transparent;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .chip-inactive {
            background-color: #e7e5e4; /* Stone 200 */
            color: #57534e;
            border-color: transparent;
        }

        /* Search Bar Focus Animation */
        .search-container:focus-within {
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: #f59e0b;
        }

        /* Card Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .menu-item {
            animation: fadeIn 0.4s ease-out forwards;
        }
    </style>
</head>
<body class="pb-24">

    <!-- HEADER & SEARCH (Sticky) -->
    <header class="sticky top-0 z-50 bg-[#faf9f6]/95 backdrop-blur-md border-b border-stone-200/50 pt-4 pb-2 px-4 shadow-sm transition-all duration-300">
        
        <!-- LOGO PRINCIPAL -->
        <div class="flex justify-start items-center mb-4 pt-2">
            <img src="La Esquina Logo_20250717_170538_0000 (2).png" 
                 alt="La Esquina Gastrobar Logo" 
                 class="h-16 w-auto object-contain">
        </div>

        <!-- Search Bar -->
        <div class="search-container relative transition-all duration-300 rounded-2xl bg-white border border-stone-200 shadow-sm mb-4">
            <span class="material-symbols-rounded absolute left-4 top-3.5 text-stone-400">search</span>
            <input type="text" id="searchInput" placeholder="¿Qué se te antoja hoy?" 
                   class="w-full bg-transparent py-3.5 pl-12 pr-4 rounded-2xl outline-none text-stone-700 placeholder-stone-400 font-medium"
                   onkeyup="filterMenu()">
        </div>

        <!-- Categories (Chips) -->
        <nav id="categoryNav" class="flex overflow-x-auto gap-2 pb-2 hide-scroll snap-x">
            <!-- Injected via JS -->
            <div class="w-20 h-9 bg-stone-200 rounded-full animate-pulse flex-shrink-0"></div>
            <div class="w-24 h-9 bg-stone-200 rounded-full animate-pulse flex-shrink-0"></div>
            <div class="w-20 h-9 bg-stone-200 rounded-full animate-pulse flex-shrink-0"></div>
        </nav>
    </header>

    <!-- MENU LIST -->
    <main class="px-4 pt-6 min-h-screen">
        
        <!-- Loader -->
        <div id="menuLoader" class="flex flex-col items-center justify-center py-20">
            <div class="w-10 h-10 border-4 border-stone-200 border-t-amber-500 rounded-full animate-spin"></div>
            <p class="mt-4 text-stone-400 text-sm font-medium animate-pulse">Preparando menú...</p>
        </div>

        <!-- Content -->
        <div id="menuContent" class="space-y-10 hidden pb-10">
            <!-- Items injected via JS -->
        </div>
        
        <!-- Empty State (Search or No Data) -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-center px-6">
            <div class="w-20 h-20 bg-stone-100 rounded-full flex items-center justify-center mb-4">
                <span class="material-symbols-rounded text-4xl text-stone-300">search_off</span>
            </div>
            <h2 class="text-lg font-bold text-stone-700">No encontramos ese plato</h2>
            <p class="text-stone-400 text-sm mt-1 max-w-[200px]">Intenta buscar por categoría o ingrediente.</p>
        </div>
    </main>

    <!-- LOGIC -->
    <script>
        const SB_URL = 'https://bxvaxcbbwhheuzlpmaex.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4dmF4Y2Jid2hoZXV6bHBtYWV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNzYxMjMsImV4cCI6MjA4NTY1MjEyM30.pIdYQfccwMrgj8Swzih2PRcqTt6_Povv_3Vp-FUGgeo';
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        let allMenuItems = [];
        let categoriesList = []; // Para guardar el orden correcto de DB
        let activeCategory = 'all';

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', async () => {
            // Cargamos categorías y platos en paralelo
            await Promise.all([fetchCategories(), fetchMenu()]);
            
            document.getElementById('menuLoader').style.display = 'none';

            if (!allMenuItems || allMenuItems.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                document.querySelector('#emptyState h2').innerText = "El menú no está disponible";
                return;
            }

            renderCategories();
            renderMenu(allMenuItems);
        });

        // --- FETCH DATA ---
        async function fetchCategories() {
            const { data, error } = await _supabase
                .from('menu_categories')
                .select('*')
                .order('sort_order', { ascending: true });
            
            if (!error && data) {
                categoriesList = data;
            }
        }

        async function fetchMenu() {
            // IMPORTANTE: Solicitamos '*, menu_categories(name)' para obtener el nombre de la categoría
            const { data, error } = await _supabase
                .from('menu_items')
                .select('*, menu_categories(name, id)')
                .eq('is_available', true);

            if (!error && data) {
                // Normalizamos los datos para facilitar el uso
                allMenuItems = data.map(item => ({
                    ...item,
                    // Si menu_categories existe, usamos el nombre, si no, 'Otros'
                    category_name: item.menu_categories ? item.menu_categories.name : 'Otros',
                    category_id: item.menu_categories ? item.menu_categories.id : 9999
                }));
            }
        }

        // --- RENDER CATEGORIES ---
        function renderCategories() {
            const nav = document.getElementById('categoryNav');
            
            // Filtramos solo categorías que tengan al menos un plato activo
            const activeCategoryNames = new Set(allMenuItems.map(i => i.category_name));
            
            // Usamos categoriesList para mantener el ORDEN definido en Admin
            const sortedCategories = categoriesList
                .filter(c => activeCategoryNames.has(c.name))
                .map(c => c.name);

            // Si hay platos sin categoría asignada (o categoría borrada), los añadimos al final
            if (activeCategoryNames.has('Otros')) {
                sortedCategories.push('Otros');
            }

            nav.innerHTML = `
                <button onclick="setCategory('all', this)" class="chip chip-active h-10 px-5 rounded-full text-sm font-bold whitespace-nowrap flex items-center snap-start border border-stone-200">
                    Todos
                </button>
            `;

            sortedCategories.forEach(cat => {
                nav.innerHTML += `
                    <button onclick="setCategory('${cat}', this)" class="chip chip-inactive h-10 px-5 rounded-full text-sm font-medium whitespace-nowrap flex items-center snap-start border border-stone-200">
                        ${cat}
                    </button>
                `;
            });
        }

        // --- FILTERING LOGIC ---
        function setCategory(cat, btn) {
            activeCategory = cat;
            
            // UI Update
            document.querySelectorAll('.chip').forEach(c => {
                c.classList.remove('chip-active');
                c.classList.add('chip-inactive');
            });
            btn.classList.remove('chip-inactive');
            btn.classList.add('chip-active');
            
            // Scroll selected chip into view
            btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });

            // Clear search when switching category
            const searchInput = document.getElementById('searchInput');
            searchInput.value = '';

            filterMenu();
        }

        function filterMenu() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const container = document.getElementById('menuContent');
            const emptyState = document.getElementById('emptyState');

            let filtered = allMenuItems;

            // 1. Filter by Category (usando category_name normalizado)
            if (activeCategory !== 'all') {
                filtered = filtered.filter(item => item.category_name === activeCategory);
            }

            // 2. Filter by Search
            if (searchTerm.length > 0) {
                filtered = filtered.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) || 
                    (item.description && item.description.toLowerCase().includes(searchTerm))
                );
            }

            // 3. Render
            if (filtered.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                document.querySelector('#emptyState h2').innerText = "No encontramos ese plato";
            } else {
                emptyState.classList.add('hidden');
                renderMenu(filtered);
            }
        }

        // --- RENDER MENU ITEMS ---
        function renderMenu(items) {
            const container = document.getElementById('menuContent');
            container.classList.remove('hidden');
            container.innerHTML = '';

            // Group by category_name
            const grouped = items.reduce((acc, item) => {
                const cat = item.category_name;
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(item);
                return acc;
            }, {});

            // Sort Categories for Display (usando el orden de DB)
            const sortedCats = Object.keys(grouped).sort((a, b) => {
                const idxA = categoriesList.findIndex(c => c.name === a);
                const idxB = categoriesList.findIndex(c => c.name === b);
                // Si no está en la lista (ej. 'Otros'), va al final
                const valA = idxA === -1 ? 9999 : categoriesList[idxA].sort_order;
                const valB = idxB === -1 ? 9999 : categoriesList[idxB].sort_order;
                return valA - valB;
            });

            sortedCats.forEach(cat => {
                const section = document.createElement('section');
                section.className = "space-y-4";
                
                section.innerHTML = `
                    <div class="flex items-center gap-4">
                        <h2 class="text-2xl font-bold text-stone-800 tracking-tight">${cat}</h2>
                        <div class="h-px bg-stone-200 flex-1"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${grouped[cat].map((item, index) => `
                            <article class="menu-item bg-white p-5 rounded-2xl shadow-sm border border-stone-100 flex flex-col justify-between group hover:border-amber-200 transition-colors" style="animation-delay: ${index * 50}ms">
                                <div class="flex justify-between items-start gap-4">
                                    <div>
                                        <h3 class="text-lg font-bold text-stone-900 leading-tight">${item.name}</h3>
                                        ${item.description ? `<p class="text-stone-500 text-sm mt-2 leading-relaxed">${item.description}</p>` : ''}
                                    </div>
                                    <span class="text-amber-700 font-bold bg-amber-50 px-3 py-1 rounded-lg text-sm whitespace-nowrap">
                                        $${item.price}
                                    </span>
                                </div>
                            </article>
                        `).join('')}
                    </div>
                `;
                container.appendChild(section);
            });
        }
    </script>
</body>
</html>