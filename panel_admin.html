<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Premium | La Esquina</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,700;0,800;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        serif: ['"Playfair Display"', 'serif']
                    },
                    colors: {
                        primary: '#111111',
                        accent: '#B89B5E',
                        surface: '#FFFFFF',
                        bg: '#F8F8F8'
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer base {
            body { @apply bg-bg text-primary antialiased; }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { @apply bg-slate-200 rounded-full; }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        
        .sortable-ghost { @apply opacity-40 bg-accent/10 border-2 border-dashed border-accent; }
        
        /* Animación pantalla completa */
        dialog#itemDialog {
            @apply fixed inset-0 m-0 w-full h-full max-w-none max-h-none border-none p-0 bg-white;
        }
        
        dialog::backdrop { @apply bg-primary/40 backdrop-blur-sm; transition: all 0.3s ease; }
        
        dialog[open] { animation: slideInFull 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        
        @keyframes slideInFull {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="pb-24">

    <!-- NAVIGATION -->
    <nav class="bg-white/70 backdrop-blur-md border-b border-slate-100 sticky top-0 z-40 px-6 py-4">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white font-serif font-bold shadow-lg">E</div>
                <div>
                    <h1 class="font-serif font-bold text-xl leading-none">Gestión Menú</h1>
                    <p class="text-[10px] font-bold text-accent uppercase tracking-widest mt-1" id="statsLabel">Cargando...</p>
                </div>
            </div>
            <button onclick="openCategoryModal()" class="w-10 h-10 rounded-full border border-slate-200 flex items-center justify-center hover:bg-slate-50 transition-colors">
                <span class="material-symbols-rounded text-slate-500">create_new_folder</span>
            </button>
        </div>
    </nav>

    <!-- HEADER & SEARCH -->
    <header class="px-6 pt-8 pb-4 max-w-4xl mx-auto">
        <div class="relative group">
            <span class="material-symbols-rounded absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">search</span>
            <input type="text" id="searchInput" placeholder="Filtrar platos..." onkeyup="filterList()" 
                   class="w-full bg-white border border-slate-200 rounded-2xl py-4 pl-12 pr-6 text-sm focus:ring-2 focus:ring-accent/20 focus:border-accent outline-none transition-all shadow-sm">
        </div>
    </header>

    <!-- CONTENT -->
    <main class="max-w-4xl mx-auto px-6 space-y-4" id="adminList">
        <div class="animate-pulse space-y-4">
            <div class="h-24 bg-white rounded-3xl"></div>
            <div class="h-24 bg-white rounded-3xl"></div>
        </div>
    </main>

    <!-- FAB -->
    <button onclick="openModal()" class="fixed bottom-8 right-8 bg-primary text-white w-14 h-14 rounded-2xl shadow-2xl flex items-center justify-center z-50 hover:bg-accent transition-all active:scale-90">
        <span class="material-symbols-rounded text-3xl">add</span>
    </button>

    <!-- ITEM DIALOG (PANTALLA COMPLETA) -->
    <dialog id="itemDialog">
        <form id="itemForm" method="dialog" onsubmit="handleSave(event)" class="flex flex-col h-full bg-white">
            <!-- Header Fijo -->
            <div class="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
                <button type="button" onclick="this.closest('dialog').close()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-500 transition-colors">
                    <span class="material-symbols-rounded">close</span>
                </button>
                <h3 id="modalTitle" class="font-serif text-xl font-bold">Nuevo Platillo</h3>
                <div class="w-10"></div> <!-- Espaciador para centrar título -->
            </div>
            
            <!-- Cuerpo Scrollable -->
            <div class="flex-grow p-8 space-y-8 overflow-y-auto custom-scrollbar">
                <input type="hidden" id="itemId">
                
                <!-- Toggle Disponibilidad -->
                <div class="flex items-center justify-between p-5 bg-slate-50 rounded-[2rem] border border-slate-100">
                    <div class="flex flex-col">
                        <span class="text-sm font-bold tracking-tight">Disponible en el Menú</span>
                        <span class="text-[11px] text-slate-400">Si se desactiva, el plato no será visible.</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="itemActive" class="sr-only peer" checked>
                        <div class="w-12 h-6 bg-slate-200 rounded-full peer peer-checked:bg-accent peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all shadow-sm"></div>
                    </label>
                </div>

                <div class="space-y-6">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1 mb-2 block">Nombre del Plato</label>
                        <input type="text" id="itemName" required class="w-full bg-slate-50 border-b-2 border-slate-100 px-4 py-4 focus:border-accent outline-none transition-colors font-medium text-lg rounded-t-2xl" placeholder="Ej: Pizza Marguerita">
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1 mb-2 block">Precio (RD$)</label>
                            <input type="number" id="itemPrice" required class="w-full bg-slate-50 border-b-2 border-slate-100 px-4 py-4 focus:border-accent outline-none font-serif text-2xl rounded-t-2xl" placeholder="0.00">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1 mb-2 block">Sección</label>
                            <div class="relative">
                                <select id="itemCategory" required class="w-full bg-slate-50 border-b-2 border-slate-100 px-4 py-4 focus:border-accent outline-none bg-transparent appearance-none rounded-t-2xl">
                                    <option value="" disabled selected>Elegir...</option>
                                </select>
                                <span class="material-symbols-rounded absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 pointer-events-none">expand_more</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1 mb-2 block">Descripción Detallada</label>
                        <textarea id="itemDesc" rows="4" class="w-full bg-slate-50 border-2 border-slate-100 p-4 rounded-2xl focus:border-accent outline-none text-sm resize-none leading-relaxed" placeholder="Describe los ingredientes, alérgenos o acompañamientos..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Footer Fijo -->
            <div class="p-6 border-t border-slate-100 flex gap-4 bg-white sticky bottom-0">
                <button type="button" id="btnDelete" onclick="deleteCurrentItem()" class="w-14 h-14 flex items-center justify-center text-red-400 bg-red-50 hover:bg-red-100 rounded-2xl transition-colors hidden shadow-sm">
                    <span class="material-symbols-rounded">delete</span>
                </button>
                <button type="submit" class="flex-1 bg-primary text-white font-bold rounded-2xl h-14 hover:bg-accent transition-all shadow-xl text-sm uppercase tracking-widest">
                    Guardar Cambios
                </button>
            </div>
        </form>
    </dialog>

    <!-- CATEGORY DIALOG (NUEVA SECCIÓN) -->
    <dialog id="categoryDialog" class="rounded-3xl shadow-2xl w-[95%] max-w-sm overflow-hidden">
        <form id="categoryForm" method="dialog" onsubmit="handleSaveCategory(event)" class="bg-white p-8">
            <h3 class="font-serif text-xl font-bold mb-6">Nueva Sección</h3>
            <div class="space-y-4">
                <input type="text" id="catName" required class="w-full border-b-2 border-slate-100 py-2 focus:border-accent outline-none font-medium" placeholder="Ej: Especiales del Mes">
                <input type="number" id="catOrder" class="w-full border-b-2 border-slate-100 py-2 focus:border-accent outline-none text-sm" placeholder="Orden (Ej: 1, 2, 3)">
            </div>
            <div class="mt-8 flex gap-3">
                <button type="button" onclick="this.closest('dialog').close()" class="flex-1 py-3 text-slate-400 font-bold text-sm">Cancelar</button>
                <button type="submit" class="flex-1 bg-primary text-white font-bold rounded-xl py-3 hover:bg-accent transition-all">Crear</button>
            </div>
        </form>
    </dialog>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-primary text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 opacity-0 translate-y-10 transition-all duration-300 pointer-events-none z-[60]">
        <span class="material-symbols-rounded text-accent">check_circle</span>
        <span id="toastMessage" class="text-xs font-bold uppercase tracking-wider">Éxito</span>
    </div>

    <script>
        const SB_URL = 'https://bxvaxcbbwhheuzlpmaex.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4dmF4Y2Jid2hoZXV6bHBtYWV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNzYxMjMsImV4cCI6MjA4NTY1MjEyM30.pIdYQfccwMrgj8Swzih2PRcqTt6_Povv_3Vp-FUGgeo';
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        let menuItems = [];
        let categories = [];
        let sortableInstance = null;

        window.addEventListener('DOMContentLoaded', async () => {
            await fetchCategories();
            await fetchMenu();
        });

        async function fetchCategories() {
            const { data } = await _supabase.from('menu_categories').select('*').order('sort_order', { ascending: true });
            categories = data || [];
            const select = document.getElementById('itemCategory');
            select.innerHTML = '<option value="" disabled selected>Elegir...</option>';
            categories.forEach(c => select.innerHTML += `<option value="${c.id}">${c.name}</option>`);
        }

        async function fetchMenu() {
            const { data } = await _supabase.from('menu_items').select('*, menu_categories(name)').order('created_at', { ascending: false });
            menuItems = data || [];
            document.getElementById('statsLabel').innerText = `${menuItems.length} PLATOS REGISTRADOS`;
            renderList(menuItems);
        }

        function openCategoryModal() {
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryDialog').showModal();
        }

        async function handleSaveCategory(e) {
            e.preventDefault();
            const name = document.getElementById('catName').value;
            const order = parseInt(document.getElementById('catOrder').value) || (categories.length + 1);
            
            const { error } = await _supabase.from('menu_categories').insert([{ name, sort_order: order }]);
            if (!error) {
                document.getElementById('categoryDialog').close();
                showToast("Sección creada");
                await fetchCategories();
                renderList(menuItems);
            }
        }

        function renderList(items) {
            const container = document.getElementById('adminList');
            container.innerHTML = '';
            const grouped = items.reduce((acc, item) => {
                const cid = item.category_id;
                if (!acc[cid]) acc[cid] = [];
                acc[cid].push(item);
                return acc;
            }, {});

            categories.forEach(cat => {
                const catItems = grouped[cat.id] || [];
                const details = document.createElement('details');
                details.open = true;
                details.dataset.id = cat.id;
                details.className = "bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden mb-6";
                details.innerHTML = `
                    <summary class="px-6 py-5 cursor-pointer flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-rounded text-slate-300 drag-handle cursor-grab">drag_indicator</span>
                            <h3 class="font-serif font-bold text-lg">${cat.name}</h3>
                        </div>
                        <span class="material-symbols-rounded text-slate-300 transition-transform">expand_more</span>
                    </summary>
                    <div class="divide-y divide-slate-50 border-t border-slate-50">
                        ${catItems.length ? catItems.map(item => `
                            <div class="p-6 flex items-center justify-between ${!item.is_available ? 'bg-slate-50/50 grayscale opacity-50' : ''}">
                                <div class="flex-1">
                                    <h4 class="font-bold text-sm mb-1">${item.name}</h4>
                                    <p class="font-serif italic text-accent font-bold">$${item.price}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="toggleVisibility(${item.id}, ${item.is_available})" class="w-10 h-10 flex items-center justify-center rounded-full border border-slate-100 text-slate-400 bg-white">
                                        <span class="material-symbols-rounded text-lg">${item.is_available ? 'visibility' : 'visibility_off'}</span>
                                    </button>
                                    <button onclick='openEditModal(${JSON.stringify(item).replace(/'/g, "&apos;")})' class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-50 text-slate-500">
                                        <span class="material-symbols-rounded text-lg">edit</span>
                                    </button>
                                </div>
                            </div>`).join('') : '<p class="p-6 text-xs text-slate-300 italic text-center">Sin platos en esta sección</p>'}
                    </div>`;
                container.appendChild(details);
            });
            initSortable();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMessage').innerText = msg;
            t.classList.replace('opacity-0', 'opacity-100');
            t.classList.replace('translate-y-10', 'translate-y-0');
            setTimeout(() => {
                t.classList.replace('opacity-100', 'opacity-0');
                t.classList.replace('translate-y-0', 'translate-y-10');
            }, 3000);
        }

        function initSortable() {
            if(sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(document.getElementById('adminList'), {
                handle: '.drag-handle', animation: 250,
                onEnd: async () => {
                    const ids = Array.from(document.querySelectorAll('details[data-id]')).map(el => el.dataset.id);
                    for(let i=0; i<ids.length; i++) {
                        await _supabase.from('menu_categories').update({sort_order: i}).eq('id', ids[i]);
                    }
                    showToast("Orden actualizado");
                }
            });
        }

        function openModal() {
            document.getElementById('itemForm').reset();
            document.getElementById('itemId').value = '';
            document.getElementById('modalTitle').innerText = 'Nuevo Platillo';
            document.getElementById('btnDelete').classList.add('hidden');
            document.getElementById('itemActive').checked = true;
            document.getElementById('itemDialog').showModal();
        }

        function openEditModal(item) {
            document.getElementById('itemId').value = item.id;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemCategory').value = item.category_id;
            document.getElementById('itemDesc').value = item.description || '';
            document.getElementById('itemActive').checked = item.is_available;
            document.getElementById('modalTitle').innerText = 'Editar Platillo';
            document.getElementById('btnDelete').classList.remove('hidden');
            document.getElementById('itemDialog').showModal();
        }

        async function handleSave(e) {
            e.preventDefault();
            const id = document.getElementById('itemId').value;
            const payload = {
                name: document.getElementById('itemName').value,
                price: parseFloat(document.getElementById('itemPrice').value),
                category_id: parseInt(document.getElementById('itemCategory').value),
                description: document.getElementById('itemDesc').value,
                is_available: document.getElementById('itemActive').checked
            };
            const { error } = id ? await _supabase.from('menu_items').update(payload).eq('id', id) : await _supabase.from('menu_items').insert([payload]);
            if (!error) { 
                document.getElementById('itemDialog').close(); 
                fetchMenu(); 
                showToast(id ? "Plato actualizado" : "Plato creado"); 
            }
        }

        async function toggleVisibility(id, status) {
            await _supabase.from('menu_items').update({is_available: !status}).eq('id', id);
            fetchMenu();
            showToast(!status ? "Plato activado" : "Plato oculto");
        }

        async function deleteCurrentItem() {
            if(confirm("¿Eliminar este plato de forma permanente?")) {
                await _supabase.from('menu_items').delete().eq('id', document.getElementById('itemId').value);
                document.getElementById('itemDialog').close();
                fetchMenu();
                showToast("Plato eliminado");
            }
        }

        function filterList() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const filtered = menuItems.filter(i => i.name.toLowerCase().includes(q));
            renderList(filtered);
        }
    </script>
</body>
</html>
